# babyjubjub-utils
Node package implementing utility functions for interacting with the Baby Jubjub curve and the [noir-elgamal](https://github.com/jat9292/noir-elgamal) Noir package. 

This package can be used in a NodeJS backend as well as inside a browser.

The baby-step giant-step algorithm (discrete logarithm computation) for the last step of decryption has been optimized via conversion to WASM and parallelization with Web Workers.

Read the documentation in this Readme after the Table of Contents. Alternatively the JSDocs can be read in the [html page](out/index.html). 

Several examples on how to use the package are available in the [tests](test/babyjubjub.js).

⚠️ **Warning:** the current implementation of the baby-step giant-step algorithm in the last step of decryption could be vulnerable to timing attacks, as the running time depends on the input. Please keep this in mind and apply extra caution if you wish to use it in production.

# How to install

Create a JS project with npm, then install the babyjubjub-utils via : 

```
npm i babyjubjub-utils
```

# How to use in a front-end

If you want to use the entirety of the functions available in a front-end, it is important to configure your module bundler correctly as this package relies on some WASM and multithreading features for decryption.

As an example, see [this simple Next JS](./nextjs-app/) project that we provided within the repository. It is doing key generation, encryption and decryption on the client side. The most crucial part is the way we set up the [`next.config.js`](./nextjs-app/next.config.js) file to make it compatible with the `babyjubjub-utils` package.

# babyjubjub-utils

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [Point][1]
    *   [Properties][2]
*   [KeyPair][3]
    *   [Properties][4]
*   [EncryptedValue][5]
    *   [Properties][6]
*   [privateToPublicKey][7]
    *   [Parameters][8]
*   [generatePrivateAndPublicKey][9]
*   [elgamalEncrypt][10]
    *   [Parameters][11]
*   [elgamalDecryptEmbedded][12]
    *   [Parameters][13]
*   [addPoints][14]
    *   [Parameters][15]
*   [packPoint][16]
    *   [Parameters][17]
*   [unpackPoint][18]
    *   [Parameters][19]
*   [bigintToBytes32][20]
    *   [Parameters][21]
*   [elgamalEncryptPacked][22]
    *   [Parameters][23]
*   [compute\_dlog][24]
    *   [Parameters][25]
*   [elgamalDecrypt][26]
    *   [Parameters][27]

## Point

Type: [Object][28]

### Properties

*   `x` **bigint** The X coordinate.
*   `y` **bigint** The Y coordinate.

## KeyPair

Type: [Object][28]

### Properties

*   `privateKey` **bigint** The private key.
*   `publicKey` **[Point][1]** The public key in uncompressed format, i.e a point on Baby Jubjub.

## EncryptedValue

Type: [Object][28]

### Properties

*   `C1` **[Point][1]** C1 is the first part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].
*   `C2` **[Point][1]** C2 is the second part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].
*   `randomness` **bigint** randomness parameter. <strong style="color: red;">Warning:</strong> should stay private and owned by the encryptor, but he could use it as a private input in the circuits.

## privateToPublicKey

Converts a private key to its corresponding public key point on the Baby Jubjub curve.

### Parameters

*   `privateKey` **bigint** The private key. <strong style="color: red;">Warning:</strong> should be a BigInt sampled randomly between 0 and l-1, where l is the order of the bigprime subgroup of Baby Jubjub. i.e l=2736030358979909402780800718157159386076813972158567259200215660948447373041

Returns **[Point][1]** The public key point with x and y coordinates which corresponds to the private key.

## generatePrivateAndPublicKey

Generates randomly a pair of private/public keys on Baby Jubjub.

Returns **[KeyPair][3]** The generated private key and its associated uncompressed/unpacked public key.

## elgamalEncrypt

Encrypts a plaintext value between 0 and 2\*\*40-1=1099511627775 for a specific publicKey. The returned ciphertext using ElGamal encryption is a pair of Baby Jubjub points (C1,C2).

### Parameters

*   `publicKey` **[Point][1]** The public key. <strong style="color: red;">Warning:</strong> The developer must ensures that this point is a valid public key, i.e a point on the big prime subgroup of Baby Jubjub.
*   `plaintext` **[number][30]** The plaintext. <strong style="color: red;">Warning:</strong> should be a number between 0 and 2\*\*40-1=1099511627775 if you want to be able to decrypt it later using the baby-step giant-step algorithm.

Returns **[EncryptedValue][5]** The encryption of plaintext. (C1,C2) is the ciphertext composed of two Baby Jubjub points, and randomness is the big integer used as randomness during encryption which should stay private for the encryptor.

## elgamalDecryptEmbedded

Decrypts the ciphertext in an embedded form, i.e as a point on the Baby Jubjub curve defined by G^(plaintext), G is the generator point.
You would still need to appy the Baby-step Giant-step algorithm via the `compute_dlog` function, to get back the original unencrypted value.

### Parameters

*   `privateKey` **bigint** The privatekey key. <strong style="color: red;">Warning:</strong> Please make sure to use the correct private key, or else the decryption will lead to an incorrect result.
*   `C1` **[Point][1]** the first part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].
*   `C2` **[Point][1]** the second part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].

Returns **[Point][1]** The decrypted value in embedded form.

## addPoints

Adds two points on the Baby Jubjub curve. Could be used for homomorphic addition of ciphertexts, eg : (C1,C2)+(C1',C2')=((C1+C1'),(C2+C2'))

### Parameters

*   `P1` **[Point][1]** First point. <strong style="color: red;">Warning:</strong> The developer must ensures that this point is on the Baby Jubjub curve.
*   `P2` **[Point][1]** Second point. <strong style="color: red;">Warning:</strong> The developer must ensures that this point is on the Baby Jubjub curve.

Returns **[Point][1]** The resulting point from addition, i.e P1+P2.

## packPoint

Packs a public key, from uncompressed form (i.e a point on the big subgroup of Baby Jubjub) to a compressed form (i.e a BigInt)

### Parameters

*   `publicKey` **[Point][1]** The uncompressed/unpacked public key. <strong style="color: red;">Warning:</strong> The developer must ensures that this point is on the Baby Jubjub curve, and more specifically in its big prime subgroup.

Returns **bigint** The resulting compressed/packed public key.

## unpackPoint

Unpacks a packed public key, this is the opposite of `packPoint`

### Parameters

*   `packedPublicKey` **bigint** The packed public key. <strong style="color: red;">Warning:</strong> The developer must ensures that it is a valid public key.

Returns **[Point][1]** The resulting compressed/packed public key.

## bigintToBytes32

Converts a bigint to a string in hex format with 0s padded on the left if needed, to later cast it easily as a bytes32 in Solidity or Noir.

### Parameters

*   `bigInt` **bigint** The big integer. <strong style="color: red;">Warning:</strong> The developer must ensures that it is a valid uint256/bytes32.

Returns **[string][31]** The resulting hex string.

## elgamalEncryptPacked

This function is identical to `elgamalEncrypt` except that it takes the public key in packed form instead of its unpacked form.
Encrypts a plaintext value between 0 and 2\*\*40-1=1099511627775 for a specific packed publicKey. The returned ciphertext using ElGamal encryption is a pair of Baby Jubjub points (C1,C2).

### Parameters

*   `packedPublicKey` **bigint** The public key. <strong style="color: red;">Warning:</strong> The developer must ensures that this point is a valid packed public key.
*   `plaintext` **[number][30]** The plaintext. <strong style="color: red;">Warning:</strong> should be a number between 0 and 2\*\*40-1=1099511627775 if you want to be able to decrypt it later using the baby-step giant-step algorithm.

Returns **[EncryptedValue][5]** The encryption of plaintext. (C1,C2) is the ciphertext composed of two Baby Jubjub points, and randomness is the big integer used as randomness during encryption which should stay private for the encryptor.

## compute\_dlog

This function solves the discrete logarithm problem by applying the baby-step giant-step algorithm (optimized implementation in WASM).
It is used to convert the decrypted value from its embedded form to its original integer value.
⚠️ <strong>Warning:</strong> the current implementation of the baby-step giant-step algorithm could be vulnerable to timing attacks, as the running time depends on the input. Please keep this in mind and apply extra caution if you wish to use it in production.

### Parameters

*   `decryptedEmbedded` **[Point][1]** The decrypted value in embedded form, i.e typically the point outputed by `elgamalDecryptEmbedded`.
*   `numberOfWorkers` **[number][30]** The number of workers used for parallelization. For faster computation we recommend between 5 to 8 workers, if the client has enough cores.

Returns **[number][30]** The integer corresponding the original unencrypted value. <strong style="color: red;">Warning:</strong> The decryption will fail if the original value was outside the \[0,2\*\*40-1] range or if a wrong private key was used during the first step of decryption.

## elgamalDecrypt

This function is identical to `elgamalDecryptEmbedded` followed by `compute_dlog`, so it returns directly the original unencrypted value as an integer, instead of its embedding on Baby Jubjub.
⚠️ <strong>Warning:</strong> the current implementation of `compute_dlog` could be vulnerable to timing attacks, as the running time depends on the input. Please keep this in mind and apply extra caution if you wish to use it in production.

### Parameters

*   `privateKey` **bigint** The privatekey key. <strong style="color: red;">Warning:</strong> Please make sure to use the correct private key, or else the decryption will fail or lead to an incorrect result.
*   `C1` **[Point][1]** the first part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].
*   `C2` **[Point][1]** the second part of the ciphertext, a point in Baby Jubjub. Same notations as on [wikipedia][29].
*   `numberOfWorkers` **[number][30]** The number of workers used for parallelization during the computation of the discrete logarithm. For faster computation we recommend between 5 to 8 workers, if the client has enough cores.

Returns **[number][30]** The integer corresponding the original unencrypted value. <strong style="color: red;">Warning:</strong> The decryption will fail if the original value was outside the \[0,2\*\*40-1] range or if a wrong private key was used.

[1]: #point

[2]: #properties

[3]: #keypair

[4]: #properties-1

[5]: #encryptedvalue

[6]: #properties-2

[7]: #privatetopublickey

[8]: #parameters

[9]: #generateprivateandpublickey

[10]: #elgamalencrypt

[11]: #parameters-1

[12]: #elgamaldecryptembedded

[13]: #parameters-2

[14]: #addpoints

[15]: #parameters-3

[16]: #packpoint

[17]: #parameters-4

[18]: #unpackpoint

[19]: #parameters-5

[20]: #biginttobytes32

[21]: #parameters-6

[22]: #elgamalencryptpacked

[23]: #parameters-7

[24]: #compute_dlog

[25]: #parameters-8

[26]: #elgamaldecrypt

[27]: #parameters-9

[28]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[29]: https://en.wikipedia.org/wiki/ElGamal_encryption

[30]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[31]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String
